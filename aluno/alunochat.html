<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat | S.A.G.A.</title>
  <link rel="icon" type="image/png" href="../logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* === Design padr√£o do SAGA === */
    :root { --font-main: 'Inter', sans-serif; }
    [data-theme='dark'] { 
      --bg-primary: #0a0a0a; --bg-secondary: #141414; --surface-color: #1a1a1a;
      --border-color: #2e2e2e; --text-primary: #f0f0f0; --text-secondary: #a0a0a0;
      --shadow-color: rgba(0, 0, 0, 0.5); --highlight-color: #ffffff;
      --accent-color: #4a6fa5; --accent-hover: #5d84c0;
      --bot-msg-bg: rgba(74, 111, 165, 0.2); --user-msg-bg: rgba(255, 255, 255, 0.1);
      --error-color: #ff5252; --warning-color: #ff9800; --success-color: #4caf50;
      --input-bg: rgba(255, 255, 255, 0.1);
    }
    [data-theme='light'] { 
      --bg-primary: #f5f5f7; --bg-secondary: #ffffff; --surface-color: #ffffff;
      --border-color: #e5e5e5; --text-primary: #1d1d1f; --text-secondary: #6e6e73;
      --shadow-color: rgba(0, 0, 0, 0.1); --highlight-color: #000000;
      --accent-color: #3a5a8c; --accent-hover: #4a6fa5;
      --bot-msg-bg: rgba(58, 90, 140, 0.15); --user-msg-bg: rgba(0, 0, 0, 0.05);
      --error-color: #e53935; --warning-color: #f57c00; --success-color: #43a047;
      --input-bg: rgba(0, 0, 0, 0.08);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-main);
      transition: background-color 0.5s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; padding-top: 6rem; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.5rem 2.5rem; border-bottom: 1px solid var(--border-color);
      background: rgba(26, 26, 26, 0.8); backdrop-filter: blur(20px);
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      transition: all 0.3s ease;
    }
    [data-theme='light'] header {
      background: rgba(255, 255, 255, 0.8);
    }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .logo-wrapper {
      display: flex; align-items: center; justify-content: center;
      width: 48px; height: 48px; background: transparent; border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10); overflow: hidden;
    }
    .logo {
      display: block; width: 48px; height: 48px; object-fit: contain;
      background: transparent; border-radius: 50%; box-shadow: none; cursor: pointer;
    }
    .header-left h1 { font-size: 1.25rem; font-weight: 600; }
    .user-controls { display: flex; align-items: center; gap: 0.5rem; }
    .user-controls button {
      background: var(--surface-color); border: 1px solid var(--border-color);
      border-radius: 50%; width: 36px; height: 36px; font-size: 1.2rem;
      cursor: pointer; color: var(--text-secondary); transition: all 0.2s ease;
      display: flex; align-items: center; justify-content: center;
    }
    .user-controls button:hover { border-color: var(--highlight-color); color: var(--highlight-color); }
    .logout-btn { background: var(--text-secondary); color: var(--bg-primary); }
    .logout-btn:hover { background: var(--highlight-color); }

    canvas#particles-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      pointer-events: none;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; padding-top: 6rem; }

    .logo {
      height: 50px;
      border-radius: 50%;
      box-shadow: 0 0 10px var(--shadow);
      cursor: pointer;
    }

    .theme-toggle {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .theme-toggle button {
      padding: 0.4rem 1rem;
      border: none;
      border-radius: 20px;
      background: var(--card-bg);
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.4s ease;
    }

    .theme-toggle button:hover {
      background: var(--shadow);
    }

    main {
      flex: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .page-title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .page-title h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .page-title p {
      font-size: 1.2rem;
      opacity: 0.8;
    }

    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: var(--surface-color);
      color: var(--text-primary);
      border-radius: 8px;
      text-decoration: none;
      cursor: pointer;
    }

    .back-btn:hover {
      background: var(--border-color);
    }

    .chat-container {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }

    .chat-box {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px var(--shadow);
      display: flex;
      flex-direction: column;
      height: 500px;
      flex: 1;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .chat-header h2 {
      font-size: 1.5rem;
    }

    .chat-header .online-count {
      background: var(--accent-color);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      max-width: 80%;
      padding: 0.8rem 1rem;
      border-radius: 15px;
      line-height: 1.4;
      position: relative;
    }

    .message .username {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .message .timestamp {
      font-size: 0.7rem;
      opacity: 0.7;
      position: absolute;
      bottom: 0.3rem;
      right: 0.8rem;
    }

    .other-message {
      align-self: flex-start;
      background: var(--card-bg);
      border-bottom-left-radius: 5px;
    }

    .my-message {
      align-self: flex-end;
      background: var(--accent-color);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .system-message {
      align-self: center;
      background: var(--shadow);
      font-style: italic;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      opacity: 0.8;
      max-width: 90%;
      text-align: center;
    }

    .cronograma-message {
      align-self: flex-start;
      background: var(--card-bg);
      border: 1px solid var(--accent-color);
      border-radius: 15px;
      padding: 1rem;
      max-width: 90%;
    }

    .chat-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      position: relative;
    }

    .chat-input input {
      flex: 1;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 1rem;
    }

    .chat-input button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 20px;
      background: var(--accent-color);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .chat-input button:hover {
      background: var(--accent-hover);
    }

    .chat-input .error-message {
      position: absolute;
      bottom: -1.5rem;
      left: 0;
      color: var(--error-color);
      font-size: 0.9rem;
    }

    .chat-rules {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px var(--shadow);
    }

    .chat-rules h3 {
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .chat-rules ul {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .chat-rules li {
      margin-bottom: 0.5rem;
    }

    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      color: var(--text-color);
      border-radius: 8px;
      text-decoration: none;
      cursor: pointer;
    }

    .back-btn:hover {
      background: var(--shadow);
    }

    @media (max-width: 768px) {
      .page-title h1 {
        font-size: 2rem;
      }
      
      .chat-box {
        padding: 1rem;
      }
      
      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-left">
      <span class="logo-wrapper">
        <img src="logo.png" alt="Saga Logo" class="logo" onclick="window.location.href='alunoinicio.html'">
      </span>
      <h1>Saga Hub</h1>
    </div>
    <div class="user-controls">
      <span id="username-display" style="color: var(--text-secondary); margin-right: 0.5rem; font-weight: 500;"></span>
      <button id="theme-toggle-dark" title="Tema Escuro">üåô</button>
      <button id="theme-toggle-light" title="Tema Claro">‚òÄÔ∏è</button>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>
  </header>

  <main>
    <a class="back-btn" onclick="window.location.href='alunoinicio.html'">‚Üê Voltar ao In√≠cio</a>
    
    <section class="page-title">
      <h1>Chat Global</h1>
      <p>Converse com outros alunos e compartilhe conhecimentos</p>
    </section>

    <div class="chat-container">
      <div class="chat-box">
        <div class="chat-header">
          <h2>Chat da Comunidade</h2>
          <div class="online-count" id="online-count">0 online</div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
          <!-- As mensagens ser√£o carregadas aqui -->
        </div>
        
        <div class="chat-input">
          <input type="text" id="message-input" placeholder="Digite sua mensagem...">
          <button id="send-button">Enviar</button>
          <div class="error-message" id="error-message"></div>
        </div>
      </div>
      
      <div class="chat-rules">
        <h3>Regras do Chat</h3>
        <ul>
          <li>Seja respeitoso com todos os participantes.</li>
          <li>N√£o use linguagem ofensiva ou palavr√µes.</li>
          <li>N√£o compartilhe informa√ß√µes pessoais.</li>
          <li>Mantenha as discuss√µes relacionadas aos estudos.</li>
          <li>Voc√™ pode compartilhar seu cronograma de estudos atrav√©s da p√°gina de Cronograma.</li>
        </ul>
        <p>O n√£o cumprimento das regras pode resultar em restri√ß√µes de acesso ao chat.</p>
      </div>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDhHGoe7GDJhMOjYSTbgqC7DHE2Dc_RR0M",
      authDomain: "saga-1d4e2.firebaseapp.com",
      projectId: "saga-1d4e2",
      storageBucket: "saga-1d4e2.firebasestorage.app",
      messagingSenderId: "419315470764",
      appId: "1:419315470764:web:4e3fd28ca21f935bc52a09",
      measurementId: "G-SSBL21VWE3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Vari√°veis globais
    let currentUser = null;
    let username = 'Aluno';
    let onlineUsers = 0;
    
    // Lista de palavras proibidas
    const palavroesProibidos = [
      // Lista de palavr√µes em portugu√™s
      'merda', 'porra', 'caralho', 'foda', 'puta', 'buceta', 'cu', 'viado', 'bicha', 'piranha',
      'cacete', 'cuz√£o', 'fdp', 'pqp', 'vsf', 'vtnc', 'bosta', 'desgra√ßa', 'idiota', 'imbecil',
      'retardado', 'ot√°rio', 'babaca', 'arrombado', 'corno', 'vagabundo', 'safado', 'putaria',
      
      // Varia√ß√µes com caracteres especiais
      'm3rd4', 'p0rr4', 'c4r4lh0', 'f0d4', 'put4', 'buc3t4', 'v14d0', 'b1ch4', 'p1r4nh4',
      'c4c3t3', 'cuz40', 'b0st4', 'd3sgr4c4', '1d10t4', '1mb3c1l', 'r3t4rd4d0', '0t4r10',
      
      // Palavras em ingl√™s
      'fuck', 'shit', 'bitch', 'asshole', 'dick', 'pussy', 'cunt', 'whore', 'slut', 'bastard',
      'damn', 'idiot', 'moron', 'retard', 'stupid', 'dumb', 'loser', 'jerk'
    ];
    
    // Express√µes regulares para detectar palavr√µes
    const palavraoRegex = new RegExp('\\b(' + palavroesProibidos.join('|') + ')\\b', 'gi');
    
    // Verificar autentica√ß√£o
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Usu√°rio est√° logado
        currentUser = user;
        username = user.email.split('@')[0];
        document.getElementById('username-display').textContent = `Ol√°, ${username}`;
        
        // Inicializar chat
        initChat();
      } else {
        // Usu√°rio n√£o est√° logado, redirecionar para login
        window.location.href = '../login.html';
      }
    });

    // Inicializar chat
    function initChat() {
      // Registrar presen√ßa online
      registerOnlinePresence();
      
      // Carregar mensagens
      loadMessages();
      
      // Configurar envio de mensagens
      setupMessageSending();
      
      // Adicionar mensagem de boas-vindas ao sistema
      addSystemMessage(`Bem-vindo ao chat, ${username}!`);
    }

    // Registrar presen√ßa online
    function registerOnlinePresence() {
      if (!currentUser) return;
      
      // Refer√™ncia para o status do usu√°rio
      const userStatusRef = db.ref(`status/${currentUser.uid}`);
      
      // Refer√™ncia para conex√£o
      const connectedRef = db.ref('.info/connected');
      
      // Monitorar estado de conex√£o
      connectedRef.on('value', (snapshot) => {
        if (snapshot.val() === true) {
          // Usu√°rio est√° conectado
          
          // Configurar para remover quando desconectar
          userStatusRef.onDisconnect().remove();
          
          // Atualizar status
          userStatusRef.set({
            username: username,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
      
      // Monitorar usu√°rios online
      db.ref('status').on('value', (snapshot) => {
        if (snapshot.exists()) {
          onlineUsers = Object.keys(snapshot.val()).length;
        } else {
          onlineUsers = 0;
        }
        
        document.getElementById('online-count').textContent = `${onlineUsers} online`;
      });
    }

    // Fun√ß√£o de logout
    function logout() {
      // Remover status online antes de sair
      if (currentUser) {
        db.ref(`status/${currentUser.uid}`).remove();
      }
      
      auth.signOut()
        .then(() => {
          window.location.href = '../login.html';
        })
        .catch((error) => {
          console.error('Erro ao fazer logout:', error);
        });
    }

    // Limpar todas as mensagens do chat
    function clearAllMessages() {
      if (confirm('Tem certeza que deseja apagar todas as mensagens do chat? Esta a√ß√£o n√£o pode ser desfeita.')) {
        db.ref('chats/geral/messages').remove()
          .then(() => {
            addSystemMessage('Todas as mensagens foram apagadas. Chat limpo!');
            console.log('Todas as mensagens foram removidas do banco de dados');
          })
          .catch((error) => {
            console.error('Erro ao limpar mensagens:', error);
            addSystemMessage('Erro ao limpar mensagens. Tente novamente.');
          });
      }
    }

    // Fun√ß√£o melhorada para filtrar palavr√µes
    function filterMessage(message) {
      let filteredMessage = message;
      
      // Aplicar regex de palavr√µes
      filteredMessage = filteredMessage.replace(palavraoRegex, (match) => {
        // Substituir por asteriscos baseado no tamanho da palavra
        return '*'.repeat(match.length);
      });
      
      // Detectar tentativas de contornar o filtro
      const suspiciousPatterns = [
        /\b[a-z]*[0-9][a-z]*\b/gi, // Palavras com n√∫meros misturados
        /\b[a-z]*[^a-z\s][a-z]*\b/gi, // Palavras com caracteres especiais
        /\b[a-z]{1,3}\s+[a-z]{1,3}\s+[a-z]{1,3}\b/gi // Palavras muito curtas separadas
      ];
      
      suspiciousPatterns.forEach(pattern => {
        filteredMessage = filteredMessage.replace(pattern, (match) => {
          const cleanMatch = match.toLowerCase().replace(/[^a-z]/g, '');
          if (palavroesProibidos.some(palavrao => 
            cleanMatch.includes(palavrao) || palavrao.includes(cleanMatch))) {
            return '*'.repeat(match.length);
          }
          return match;
        });
      });
      
      return filteredMessage;
    }

    // Carregar mensagens
    function loadMessages() {
      const messagesContainer = document.getElementById('chat-messages');
      
      // Limpar mensagens existentes
      messagesContainer.innerHTML = '';
      
      // Adicionar mensagem de carregamento
      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'message system-message';
      loadingMessage.textContent = 'Carregando mensagens...';
      loadingMessage.id = 'loading-message';
      messagesContainer.appendChild(loadingMessage);
      
      // Limitar a 50 mensagens mais recentes
      db.ref('chats/geral/messages').limitToLast(50).once('value')
        .then((snapshot) => {
          // Remover mensagem de carregamento
          const loadingMsg = document.getElementById('loading-message');
          if (loadingMsg) loadingMsg.remove();
          
          // Verificar se h√° mensagens
          if (!snapshot.exists()) {
            addSystemMessage('Nenhuma mensagem ainda. Seja o primeiro a enviar!');
            return;
          }
          
          // Processar mensagens
          snapshot.forEach((childSnapshot) => {
            const message = childSnapshot.val();
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
          });
          
          // Rolar para a √∫ltima mensagem
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // Configurar listener para novas mensagens
          setupNewMessageListener();
        })
        .catch((error) => {
          console.error('Erro ao carregar mensagens:', error);
          addSystemMessage('Erro ao carregar mensagens. Tente novamente mais tarde.');
        });
    }
    
    // Configurar listener para novas mensagens
    function setupNewMessageListener() {
      const messagesContainer = document.getElementById('chat-messages');
      
      // Listener para novas mensagens
      const messagesRef = db.ref('chats/geral/messages').limitToLast(1);
      messagesRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        
        // Verificar se a mensagem j√° est√° no DOM
        const messageId = snapshot.key;
        if (document.querySelector(`[data-message-id="${messageId}"]`)) {
          return;
        }
        
        const messageElement = createMessageElement(message, messageId);
        messagesContainer.appendChild(messageElement);
        
        // Rolar para a √∫ltima mensagem
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Adicionar mensagem do sistema
    function addSystemMessage(text) {
      const messagesContainer = document.getElementById('chat-messages');
      
      const messageElement = document.createElement('div');
      messageElement.className = 'message system-message';
      messageElement.textContent = text;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Criar elemento de mensagem
    function createMessageElement(message, messageId) {
      const messageElement = document.createElement('div');
      if (messageId) {
        messageElement.setAttribute('data-message-id', messageId);
      }
      
      // Verificar se √© uma mensagem do sistema
      if (message.isSystem) {
        messageElement.className = 'message system-message';
        messageElement.textContent = message.text;
        return messageElement;
      }
      
      // Verificar se √© uma mensagem de cronograma
      if (message.isCronograma) {
        messageElement.className = 'message cronograma-message';
        
        const usernameElement = document.createElement('div');
        usernameElement.className = 'username';
        usernameElement.textContent = message.username;
        
        const contentElement = document.createElement('div');
        contentElement.innerHTML = message.text;
        
        const timestampElement = document.createElement('div');
        timestampElement.className = 'timestamp';
        timestampElement.textContent = formatTimestamp(message.timestamp);
        
        messageElement.appendChild(usernameElement);
        messageElement.appendChild(contentElement);
        messageElement.appendChild(timestampElement);
        
        return messageElement;
      }
      
      // Mensagem normal
      const isMyMessage = message.username === username;
      messageElement.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
      
      const usernameElement = document.createElement('div');
      usernameElement.className = 'username';
      usernameElement.textContent = message.username;
      
      const contentElement = document.createElement('div');
      
      // Filtrar mensagem antes de exibir
      const filteredText = filterMessage(message.text);

      // Verificar se √© HTML ou texto simples
      if (message.isHtml) {
        contentElement.innerHTML = filteredText;
      } else {
        contentElement.textContent = filteredText;
      }
      
      const timestampElement = document.createElement('div');
      timestampElement.className = 'timestamp';
      timestampElement.textContent = formatTimestamp(message.timestamp);
      
      messageElement.appendChild(usernameElement);
      messageElement.appendChild(contentElement);
      messageElement.appendChild(timestampElement);
      
      return messageElement;
    }

    // Formatar timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${hours}:${minutes}`;
    }

    // Configurar envio de mensagens
    function setupMessageSending() {
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const errorMessage = document.getElementById('error-message');
      
      // Fun√ß√£o para enviar mensagem
      function sendMessage() {
        const text = messageInput.value.trim();
        
        if (text === '') return;
        
        // Verificar palavr√µes
        if (containsPalavroes(text)) {
          errorMessage.textContent = 'Sua mensagem cont√©m palavras n√£o permitidas.';
          messageInput.classList.add('error');
          
          // Limpar erro ap√≥s 3 segundos
          setTimeout(() => {
            errorMessage.textContent = '';
            messageInput.classList.remove('error');
          }, 3000);
          
          return;
        }
        
        // Limpar erro se existir
        errorMessage.textContent = '';
        messageInput.classList.remove('error');
        
        // Desabilitar bot√£o durante o envio
        sendButton.disabled = true;
        
        // Enviar mensagem para o Firebase
        db.ref('chats/geral/messages').push({
          username: username,
          text: text,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        })
        .then(() => {
          messageInput.value = '';
          sendButton.disabled = false;
        })
        .catch((error) => {
          console.error('Erro ao enviar mensagem:', error);
          errorMessage.textContent = 'Erro ao enviar mensagem. Tente novamente.';
          sendButton.disabled = false;
        });
      }
      
      // Event listeners
      sendButton.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    }

    // Verificar se o texto cont√©m palavr√µes
    function containsPalavroes(text) {
      // Converter para min√∫sculas para facilitar a compara√ß√£o
      const lowerText = text.toLowerCase();
      
      // Verificar palavras exatas
      if (palavraoRegex.test(lowerText)) {
        return true;
      }
      
      // Verificar palavras com caracteres repetidos (ex: meeeerda)
      for (const palavrao of palavroesProibidos) {
        // Criar regex que permite repeti√ß√£o de caracteres
        const regexPattern = palavrao.split('').join('+');
        const flexibleRegex = new RegExp(regexPattern, 'i');
        
        if (flexibleRegex.test(lowerText)) {
          return true;
        }
      }
      
      return false;
    }

    // Tema
    // Sistema de tema padr√£o
    const applyTheme = (theme) => {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('saga-theme', theme);
    };
    
    document.getElementById('theme-toggle-dark').addEventListener('click', () => applyTheme('dark'));
    document.getElementById('theme-toggle-light').addEventListener('click', () => applyTheme('light'));
    
    window.addEventListener('DOMContentLoaded', () => {
      applyTheme(localStorage.getItem('saga-theme') || 'dark');
    });

    // Particles.js
    function initParticles() {
      const color = getComputedStyle(document.documentElement)
        .getPropertyValue('--particle-color').trim();

      particlesJS("particles-js", {
        particles: {
          number: { value: 60 },
          color: { value: color },
          opacity: { value: 0.5 },
          shape: { type: "circle" },
          size: { value: 3 },
          line_linked: {
            enable: true,
            distance: 150,
            color: color,
            opacity: 0.4,
            width: 1
          },
          move: {
            enable: true,
            speed: 2,
            direction: "none",
            out_mode: "out"
          }
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: { enable: true, mode: "repulse" }
          },
          modes: {
            repulse: { distance: 100, duration: 0.4 }
          }
        },
        retina_detect: true
      });
    }

    function updateParticles() {
      if (window.pJSDom?.length) {
        const color = getComputedStyle(document.documentElement)
          .getPropertyValue('--particle-color').trim();
        const pjs = window.pJSDom[0].pJS;
        pjs.particles.color.value = color;
        pjs.particles.line_linked.color = color;
        pjs.fn.particlesRefresh();
      }
    }
    
    // Inicializar banco de dados se necess√°rio
    function initializeDatabase() {
      // Verificar se o n√≥ de mensagens existe
      db.ref('chats/geral/messages').once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            // Criar mensagem inicial
            db.ref('chats/geral/messages').push({
              username: 'Sistema',
              text: 'Bem-vindo ao chat do S.A.G.A.! Este √© o in√≠cio da conversa.',
              isSystem: true,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            });
          }
        });
    }
    
    // Chamar inicializa√ß√£o do banco de dados
    initializeDatabase();
  </script>

  <!-- Particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
</body>
</html>
