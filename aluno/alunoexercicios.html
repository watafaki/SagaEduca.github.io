<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
   import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

   // Configura√ß√£o do Firebase e L√≥gica de Tema (sem altera√ß√µes)
   const firebaseConfig = {
     // ATEN√á√ÉO: √â mais seguro configurar restri√ß√µes de dom√≠nio no seu painel do Firebase.
     apiKey: "AIzaSyDhHGoe7GDJhMOjYSTbgqC7DHE2Dc_RR0M", // Chave exposta!
     authDomain: "saga-1d4e2.firebaseapp.com",
     projectId: "saga-1d4e2",
   };
   const app = initializeApp(firebaseConfig);
   const auth = getAuth(app);
   onAuthStateChanged(auth, (user) => {
     if (user) {
       document.getElementById('username-display').textContent = user.email.split('@')[0];
     } else {
       window.location.href = '../login.html';
     }
   });
   window.logout = () => {
       signOut(auth).then(() => {
           if (window.navigateWithVinheta) {
               window.navigateWithVinheta('../login.html');
           } else {
               window.location.href = '../login.html';
           }
       }).catch(error => console.error('Logout error', error));
   };
   const themeToggleDark = document.getElementById('theme-toggle-dark');
   const themeToggleLight = document.getElementById('theme-toggle-light');
   const applyTheme = (theme) => {
     document.documentElement.setAttribute('data-theme', theme);
     localStorage.setItem('saga-theme', theme);
     
     // Atualiza a logo baseada no tema
     const logo = document.querySelector('.logo');
     if (logo) {
       if (theme === 'light' || theme === 'claro') {
         logo.src = 'logoinvertido.png';
       } else {
         logo.src = 'logo.png';
       }
     }
   };
   themeToggleDark.addEventListener('click', () => applyTheme('dark'));
   themeToggleLight.addEventListener('click', () => applyTheme('light'));
   document.addEventListener('DOMContentLoaded', () => {
       const savedTheme = localStorage.getItem('saga-theme') || 'dark';
       applyTheme(savedTheme);
   });

   // =========================================================
   // L√ìGICA DO GERADOR DE EXERC√çCIOS (COM EXTRA√á√ÉO DE JSON ROBUSTA)
   // =========================================================
   const generatorForm = document.getElementById('generator-form');
   const generateBtn = document.getElementById('generate-btn');
   const topicInput = document.getElementById('topic-input');
   const modal = document.getElementById('quiz-modal');
   const modalBody = document.getElementById('modal-body');
   const modalFooter = document.getElementById('modal-footer');
   const modalCloseBtn = document.getElementById('modal-close-btn');
   const modalTitle = document.getElementById('modal-title');

   // ATEN√á√ÉO: Sua chave est√° exposta publicamente aqui.
   // Qualquer um pode us√°-la. Remova e use um backend para seguran√ßa.
   const GEMINI_API_KEY = "AIzaSyBLqRWbtcDPJnubcf8O0ojPQ5cvmFDCB2o"; // Chave exposta!

   // ***** CORRE√á√ÉO APLICADA AQUI *****
   const API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent`;
   
   let generatedQuestions = [];

   const openModal = () => {
       modal.style.display = 'flex';
       document.body.classList.add('modal-open');
   };
   const closeModal = () => {
       modal.style.display = 'none';
       document.body.classList.remove('modal-open');
   };
   modalCloseBtn.addEventListener('click', closeModal);

   generatorForm.addEventListener('submit', async (e) => {
       e.preventDefault();
       const topic = topicInput.value.trim();
       if (!topic) return;

       generateBtn.disabled = true;
       generateBtn.textContent = 'Gerando...';
       openModal();
       modalTitle.textContent = `Quiz sobre: ${topic}`;
       modalBody.innerHTML = '<div class="loading-spinner"></div>';
       modalFooter.innerHTML = '';
       
       await generateExercises(topic);
       
       generateBtn.disabled = false;
       generateBtn.textContent = 'Gerar Quiz';
   });

   async function generateExercises(topic) {
       const prompt = `Aja como um tutor acad√™mico. Gere 3 quest√µes de m√∫ltipla escolha em portugu√™s sobre o tema "${topic}". Cada quest√£o deve ter 5 alternativas (A, B, C, D, E) e apenas uma correta. Para cada quest√£o, forne√ßa: 1. A pergunta. 2. As 5 op√ß√µes. 3. O √≠ndice da resposta correta (de 0 a 4). 4. Uma explica√ß√£o clara e concisa da resposta. 5. Um array com 2 sugest√µes de termos de busca em portugu√™s para encontrar v√≠deos educacionais no YouTube sobre o t√≥pico espec√≠fico da pergunta. Retorne a resposta EXCLUSIVAMENTE em formato de array JSON, sem nenhum texto ou formata√ß√£o adicional. Siga este modelo de estrutura JSON: [{"pergunta": "Qual √© a pergunta?","opcoes": ["Op√ß√£o A", "Op√ß√£o B", "Op√ß√£o C", "Op√ß√£o D", "Op√ß√£o E"],"resposta": 2,"explicacao": "A explica√ß√£o da resposta correta.","youtubeSearchTerms": ["primeiro termo de busca", "segundo termo de busca"]}]`;

       try {
           const response = await fetch(`${API_ENDPOINT}?key=${GEMINI_API_KEY}`, { // Adicionado key na URL
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
               },
               body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
           });
           
           const data = await response.json();

           if (!response.ok) {
               const errorMessage = data?.error?.message || `Erro desconhecido. Status: ${response.status}`;
               throw new Error(errorMessage);
           }

           // Verifica√ß√£o de seguran√ßa da resposta
           if (data.promptFeedback && data.promptFeedback.blockReason) {
                throw new Error(`A resposta da IA foi bloqueada por seguran√ßa. Motivo: ${data.promptFeedback.blockReason}`);
            }

           if (!data.candidates || data.candidates.length === 0) {
               throw new Error("A resposta da IA foi bloqueada ou veio vazia. Tente um t√≥pico diferente.");
           }

           const responseText = data.candidates[0].content.parts[0].text;
           
           const startIndex = responseText.indexOf('[');
           const endIndex = responseText.lastIndexOf(']');
           
           if (startIndex === -1 || endIndex === -1) {
               throw new Error("A IA n√£o retornou um formato de quiz v√°lido (JSON n√£o encontrado).");
           }
           
           const jsonString = responseText.substring(startIndex, endIndex + 1);

           generatedQuestions = JSON.parse(jsonString);
           displayGeneratedQuestions(generatedQuestions);

       } catch (error) {
           console.error("DETALHES DO ERRO:", error);
           modalBody.innerHTML = `
               <p style="text-align: center; color: var(--error-color); font-weight: bold; margin-bottom: 1rem;">
                   Falha ao Processar a Resposta da IA
               </p>
               <p style="text-align: center; color: var(--text-secondary);">
                   <strong>Erro:</strong><br>
                   "${error.message}"
               </p>
               <p style="text-align: center; color: var(--text-secondary); margin-top: 1.5rem;">
                   Isso pode acontecer se a IA responder de forma inesperada ou o conte√∫do for bloqueado. Tente ser mais espec√≠fico no seu t√≥pico ou tente novamente.
               </p>
           `;
       }
   }
   
   // As fun√ß√µes displayGeneratedQuestions e checkAnswers continuam as mesmas...
   function displayGeneratedQuestions(questions) {
       modalBody.innerHTML = '';
       questions.forEach((q, index) => {
           const optionsHtml = q.opcoes.map((opt, optIndex) => `
               <div class="option-item" data-question="${index}" data-option="${optIndex}">
                   <strong>${String.fromCharCode(65 + optIndex)}.&nbsp;</strong> ${opt}
               </div>
           `).join('');
           const youtubeLinksHtml = q.youtubeSearchTerms.map(term => `
               <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(term)}" target="_blank">üé¨ ${term}</a>
           `).join('');
           modalBody.innerHTML += `
               <div class="exercise-item" id="q-${index}">
                   <div class="exercise-question">${index + 1}. ${q.pergunta}</div>
                   <div class="exercise-options">${optionsHtml}</div>
                   <div class="feedback-container" id="feedback-${index}">
                       <div class="explanation">${q.explicacao}</div>
                       <div class="youtube-suggestion">
                           <h4>Sugest√µes de estudo no YouTube:</h4>
                           ${youtubeLinksHtml}
                       </div>
                   </div>
               </div>`;
       });
       modalFooter.innerHTML = '<button class="generator-button" id="check-answers-btn">Verificar Respostas</button>';
       document.querySelectorAll('.option-item').forEach(item => {
           item.addEventListener('click', () => {
               const qIndex = item.dataset.question;
               document.querySelectorAll(`.option-item[data-question="${qIndex}"]`).forEach(opt => opt.classList.remove('selected'));
               item.classList.add('selected');
           });
       });
       document.getElementById('check-answers-btn').addEventListener('click', checkAnswers);
   }
   
   function checkAnswers() {
       generatedQuestions.forEach((q, index) => {
           const options = document.querySelectorAll(`.option-item[data-question="${index}"]`);
           const selectedOption = document.querySelector(`.option-item[data-question="${index}"].selected`);
           const feedbackContainer = document.getElementById(`feedback-${index}`);
           options.forEach(opt => opt.style.pointerEvents = 'none');
           if (selectedOption) {
               const selectedAnswer = parseInt(selectedOption.dataset.option);
               if (selectedAnswer === q.resposta) {
                   selectedOption.classList.add('correct');
               } else {
                   selectedOption.classList.add('incorrect');
                   options[q.resposta].classList.add('correct');
                   feedbackContainer.style.display = 'block';
               }
           } else {
               options[q.resposta].classList.add('correct');
               feedbackContainer.style.display = 'block';
           }
       });
       this.disabled = true;
       this.textContent = 'Verificado!';
   }
 </script>
